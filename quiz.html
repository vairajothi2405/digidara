<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quiz</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='quiz.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="quiz-container">
        <!-- Score Display -->
        <div class="score-box">
            <h3 id="score">Score: 0</h3>
        </div>

        <!-- Question Number -->
        <h2 id="qno">Waiting for question...</h2>

        <!-- Question Text -->
        <div class="question-box">
            <p id="question" class="question-text"></p>
        </div>

        <!-- Options -->
        <div id="options" class="options-box"></div>

        <!-- Timer -->
        <p id="timer" class="timer-box"></p>
    </div>

    <script>
        const socket = io();
        let optionsDiv = document.getElementById("options");
        let timerInterval;
        let timeLeft;
        let questionStartTime;

        // Join quiz when page loads
        socket.emit("join_quiz");

        // Receive new question from server
        socket.on("new_question", data => {
            questionStartTime = Date.now();
            timeLeft = data.time;

            document.getElementById("qno").innerText = "Question " + data.qno;
            document.getElementById("question").innerText = data.question;
            optionsDiv.innerHTML = "";

            // Render options as buttons
            data.options.forEach(opt => {
                let btn = document.createElement("button");
                btn.innerText = opt;

                btn.onclick = () => {
                    clearInterval(timerInterval); // Stop timer
                    let timeTaken = Math.floor((Date.now() - questionStartTime)/1000);

                    socket.emit("submit_answer", {
                        answer: opt,
                        time_taken: timeTaken
                    });
                };
                optionsDiv.appendChild(btn);
            });

            // Start timer
            document.getElementById("timer").innerText = "Time: " + timeLeft;
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById("timer").innerText = "Time: " + timeLeft;

                if(timeLeft <= 0){
                    clearInterval(timerInterval);
                    socket.emit("submit_answer", { answer:"", time_taken: data.time });
                }
            }, 1000);
        });

        // Receive result for the selected answer
        socket.on("answer_result", data => {
            [...optionsDiv.children].forEach(btn => {
                btn.disabled = true;
                if(btn.innerText === data.correct) btn.style.backgroundColor = "green";
                if(btn.innerText === data.selected && data.selected !== data.correct) btn.style.backgroundColor = "red";
            });
            document.getElementById("score").innerText = "Score: " + data.score;
        });

        // Quiz finished
        socket.on("quiz_finished", data => {
            document.body.innerHTML = `
                <div class="quiz-finished">
                    <h1>ðŸŽ‰ Quiz Finished ðŸŽ‰</h1>
                    <h3>Your Score: ${data.final_score}</h3>
                </div>`;
        });
    </script>
</body>
</html>